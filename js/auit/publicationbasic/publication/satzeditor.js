(function(c){if(window.AuIt==undefined){window.AuIt={}}var b=null;var a={mainModel:null,mapping:{templates:{create:function(e){return new SETemplate(e)}},vars:{create:function(e){return new SEVar(e)}}},ElementToJSON:function(f){var e=AuIt.ElementToJSON(f);delete e.__ko_mapping__;delete e["$type"];delete e["$type_"];delete e["$parent"];delete e["$model"];return e},};function d(e){var g,h=[];for(var f=0;f<e.length;f++){g=e[f].strip();if(g){h.push(g)}}return h}SEVar=function(e){this.uid=ko.observable();this.def=ko.observable();this.spread=ko.observable();this.name=ko.observable();this.type=ko.observable();this.spread=ko.observable();this.tempname=ko.observable();ko.mapping.fromJS(e.data,a.mapping,this)};SEVar.prototype={toJSON:function(){var e=a.ElementToJSON(this);delete e.tempname;return e},selectImageFile:function(){var e=this.src();AuIt.FileManager.box_box=this;AuIt.FileManager.show(e,function(f){AuIt.FileManager.box_box.src(f)})}};SETemplate=function(g){var e=this;e.$type="Template";e.$model=this;e.template=ko.observable("");e.usespread=ko.observable(0);e.skus=ko.observable();e.currentSKUIdx=ko.observable(0);e.templateInfo=ko.observable();e.vars=ko.observableArray();if(!g.data.skus){g.data.skus=""}if(g.data.vars){var f=[];g.data.vars.each(function(h){if(h.spread!=undefined){f.push(h)}});g.data.vars=f}ko.mapping.fromJS(g.data,a.mapping,this);e.products=ko.observableArray(d(e.skus().split(",")));e.block=false;e.products.subscribe(function(h){h.forEach(function(i){if(i.status==="added"){a.mainModel.updateGridSku(i.value,true)}if(i.status==="deleted"){a.mainModel.updateGridSku(i.value,false)}});if(e.block){return}e.block=true;e.skus(e.products().join(","));e.block=false},null,"arrayChange");e.skus.subscribe(function(h){if(e.block){return}e.block=true;e.products(d(e.skus().split(",")));e.block=false});e.template.subscribe(function(h){e.templateInfo("");e.loadTemplateInfo()})};SETemplate.prototype={toJSON:function(){var e=a.ElementToJSON(this);delete e.products;delete e.templateInfo;return e},getPrevProductUrl:function(e){return AuIt.SatzEditor.productImageUrl.replace("[rep]",e)},getTemplName:function(){if(AuIt.SatzEditor.templateTypes[this.template()]){return AuIt.SatzEditor.templateTypes[this.template()]}return this.template()},getPrevTemplUrl:function(){var e=AuIt.SatzEditor.templateImageUrl.replace("[rep]",this.template()).replace("[date]",(new Date()).getTime()).replace("[spread]",this.usespread());return e},activedTemplate:function(){a.mainModel.activedTemplate(this)},isSelected:function(e){return a.mainModel.isActivedTemplate(this)},getSKUIndex:function(e){return this.templates.indexOf(e)},activedSKUIdx:function(h,f){var g=ko.dataFor(f.currentTarget.parentNode);if(g){var e=c(f.currentTarget).attr("data-index");g.currentSKUIdx(e)}},isActivedSKUIdx:function(e){return this.currentSKUIdx()==e()},getCurrentSKU:function(){if(this.currentSKUIdx()>=0){return this.products()[this.currentSKUIdx()()]}return null},onTrash:function(){this.removeProduct(this.currentSKUIdx())},removeProduct:function(f){this.products.splice(f,1);var e=this.products().length;if(this.currentSKUIdx()<0||this.currentSKUIdx()>=e){this.currentSKUIdx(e-1)}},addProduct:function(f,e){var g=0;switch(e){case"0":this.products.unshift(f);g=0;break;case"1":var g=this.currentSKUIdx();if(g<0){g=0}this.products.splice(g,0,f);break;case"2":var g=parseFloat(this.currentSKUIdx())+1;this.products.splice(g,0,f);break;default:this.products.push(f);g=this.products().length-1;break}this.currentSKUIdx(g)},loadTemplateInfo:function(){var e=this;var f=e.templateInfo();if(!f){c.ajax({async:true,type:"POST",url:AuIt.SatzEditor.templateInfoUrl,data:{form_key:AuIt.SatzEditor.formKey,operation:"staticvariables",id:e.template()},success:function(g){if(g&&g.identifier){a.mainModel.templates().each(function(h){if((h.template()==g.identifier)&&!h.templateInfo()){h.templateInfo(g)}})}}})}},getCurrentVarGroups:function(){var e=[];var f=this;var i=f.templateInfo();if(i){var h={};var g=f.usespread();g=g=="0"?false:g;i.vars.each(function(j){if(!g||g==j.spread){if(!h[j.spread]){h[j.spread]={id:j.spread,tmpls:{}}}if(!h[j.spread].tmpls[j.tempname]){h[j.spread].tmpls[j.tempname]={name:j.tempname,boxs:[]}}h[j.spread].tmpls[j.tempname].boxs.push(j)}});i.spreads.each(function(k){if(!g||k.idx==g){if(h[k.idx]){h[k.idx].name=k.name;var l=h[k.idx].tmpls;h[k.idx].tmpls=[];for(var j in l){if(l[j].boxs){h[k.idx].tmpls.push(l[j])}}e.push(h[k.idx])}}})}return e},findVarObj:function(f){var e=ko.utils.arrayFirst(this.vars(),function(g){return f.uid==g.uid()&&f.spread==g.spread()});return e},getVarBox:function(f){var e=this;var g=null;if(g=this.findVarObj(f)){return g}this.vars.push(new SEVar({data:f}));if(g=this.findVarObj(f)){return g}return null}};SEMain=function(f){var e=this;e.$type="SatzEditor";e.$model=this;e.templates=ko.observableArray();e.currentTemplate=ko.observable(0);e.insertModus=ko.observable("3");e.jobstyle=ko.observable(0);e.currentTemplate.subscribe(function(g){e.updateGrid()});this.loadData(f)};SEMain.prototype={loadData:function(f){var e=this;ko.mapping.fromJS(f,a.mapping,this)},toJSON:function(){var e=a.ElementToJSON(this);return e},defaultButtonClick:function(){return false},getTemplateIndex:function(e){return this.templates.indexOf(e)},activedTemplate:function(e){this.currentTemplate(this.getTemplateIndex(e))},isActivedTemplate:function(e){return this.currentTemplate()==this.getTemplateIndex(e)},getCurrentTemplate:function(){if(this.currentTemplate()>=0){return this.templates()[this.currentTemplate()]}return null},onTrash:function(){this.removeTemplate(this.currentTemplate())},removeTemplate:function(f){if(this.templates().length<=1){return}this.templates.splice(f,1);var e=this.templates().length;if(this.currentTemplate()<0||this.currentTemplate()>=e){this.currentTemplate(e-1)}},copyTemplate:function(){var g=this.templates()[this.currentTemplate()];var h=ko.toJSON(g);h=JSON.parse(h);var f=this.currentTemplate();var e=new SETemplate({data:h});this.templates.splice(f+1,0,e)},updateGridSku:function(h,g){var e=c("#auit_publicationbasic_catalog_skus2_content");var f=e.find('input[type="checkbox"][value="'+h+'"]');if(f.get(0)&&b){b.setCheckboxChecked(f.get(0),g)}},updateGrid:function(){var e=this;if(e.getCurrentTemplate()){e.getCurrentTemplate().loadTemplateInfo();var g=e.getCurrentTemplate().skus();var f=c("#auit_publicationbasic_catalog_skus2_content");f.find("input:checkbox").each(function(){if(this&&b){c(this).addClass("no-changes");b.setCheckboxChecked(this,false)}});g.split(",").each(function(h){h=h.strip();var i=f.find('input[type="checkbox"][value="'+h+'"]');if(i.get(0)&&b){b.setCheckboxChecked(i.get(0),true)}})}},updateSKU:function(h,g){var f=this;if(f.getCurrentTemplate()){var e=f.getCurrentTemplate().products.indexOf(h);if((e>=0)&&!g){f.getCurrentTemplate().products.remove(h)}else{if((e<0)&&g){f.getCurrentTemplate().addProduct(h,f.insertModus())}else{if(e>=0){f.getCurrentTemplate().currentSKUIdx(e)}}}}},hasSku:function(f){var e=this;if(e.getCurrentTemplate()){return e.getCurrentTemplate().products.indexOf(f)>=0}return false},previewData:function(h){var g=AuIt.SatzEditor.save();var e="";c("#edit_form").find("input, select").each(function(i){var j=c(this);e+='<input type="hidden" value="'+j.val()+'" name="'+j.attr("name")+'"/>'});c("#edit_form").find("textarea").each(function(i){var j=c(this);e+='<textarea  name="'+j.attr("name")+'">'+j.val()+"</textarea>"});var f=c('<form style="display:none" target="PDF_PREVIEW" method="POST" action="'+AuIt.SatzEditor.previewUrl+'">'+e+"</form>");c(document.body).append(f);f.submit();f.remove();return false}};AuIt.SatzEditor=function(){return{mainModel:function(){return a.mainModel},init:function(h){if(!h){h={}}a.mainModel=new SEMain(h);ko.applyBindings(a.mainModel,document.getElementById("auit-publicationbasic-satz"));a.mainModel.updateGrid();var e=c("#auit-publicationbasic-panel");c("#auit-publicationbasic-panel").width(c("#page_tabs").width()-2).position({of:c("#page_tabs"),my:"left top",at:"left bottom",offset:"0 5",});var g=c(window).height();var f=c("#page_tabs").position().top+c("#page_tabs").height();e.height(g-f-20);c("#auit-publicationbasic-satz-frame").height(g-c("#edit_form").position().top-30);c(window).bind("scroll resize",function(){var k=0;if(window.pageYOffset){k=window.pageYOffset}else{if(document.documentElement&&document.documentElement.scrollTop){k=document.documentElement.scrollTop}else{if(document.body){k=document.body.scrollTop}}}var j=c(window).height();if(k>140){c("#auit-publicationbasic-panel").addClass("fixed");e.height(j-55)}else{c("#auit-publicationbasic-panel").removeClass("fixed");var i=c("#page_tabs").position().top+c("#page_tabs").height();e.height(j-i-20)}c("#auit-publicationbasic-satz-frame").height(j-c("#edit_form").position().top-30)});c("#auit-publicationbasic-satz-frame").show();c("#auit-publicationbasic-panel").show();c("#auit-publicationbasic-satz").removeClass("a-loading")},getJSON:function(){if(a.mainModel){return ko.toJSON(a.mainModel)}throw ("No model found")}}}();window.auit_l_product_fields={gridRowClick:function(e,g){b=e;var h=c(g.currentTarget).find("input:checkbox");if(h.get(0)){var f=h.get(0).checked;e.setCheckboxChecked(h.get(0),f)}},gridCheckboxCheck:function(f,e,g){b=f;if(c(e).parents("th").length){return}var h=e.value;if(h&&a.mainModel){a.mainModel.updateSKU(h,g)}},gridRowInit:function(e,g){b=e;var f=c(g).find("input:checkbox");if(f[0]&&a.mainModel){e.setCheckboxChecked(f[0],a.mainModel.hasSku(f[0].value))}}};ko.bindingHandlers.scrollToActive={update:function(h,k,j,n,i){if(k()){c(h).addClass("active");var f=h.offsetLeft-h.parentNode.offsetLeft;var m=h.parentNode.offsetWidth;var g=h.parentNode.offsetWidth;var e=h.parentNode.scrollLeft;if(f<e){h.parentNode.scrollLeft=f-20}else{if(f>e+g){h.parentNode.scrollLeft=f}}}else{c(h).removeClass("active")}}};ko.bindingHandlers.sortableList={init:function(g,h,k,f){var e=h();var j=e.list?e.list:e;c(g).data("sortList",j);var i={update:function(p,q){var o=q.item.data("sortItem");if(o){var m=q.item.data("parentList");var n=q.item.parent().data("sortList");var l=ko.utils.arrayIndexOf(q.item.parent().children(),q.item[0]);if(l>=0){m.remove(o);n.splice(l,0,o)}q.item.remove()}},};if(e.conectWith){i.connectWith=e.conectWith}c(g).sortable(i)}};ko.bindingHandlers.sortableItem={init:function(f,g){var e=g();c(f).data("sortItem",e.item);c(f).data("parentList",e.parentList)}};ko.bindingHandlers.visibleAndSelect={update:function(e,f){ko.bindingHandlers.visible.update(e,f);if(f()){setTimeout(function(){c(e).focus().select()},0)}}};ko.bindingHandlers.setLoadingSrc={update:function(f,g){var h=g();var e=new Image();e.onload=function(){c(f).parent().removeClass("a-loading");f.src=e.src};e.src=h;e.src=h;if(!e.complete){c(f).parent().addClass("a-loading")}}}})(jQuery);