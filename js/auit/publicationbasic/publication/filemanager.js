(function(a){a.jstree._fn._search_open=function(b){var d=this;if(this.data.search.to_open.length){var c=this.data.search.to_open.shift();d.open_node(c,function(){if(d.data.search.to_open.length==1){AuIt.FileManagerOption.initialItem=d.data.search.to_open[0];d.deselect_all();d.select_node(c)}d._search_open(true)})}};if(window.AuIt==undefined){window.AuIt={}}AuIt.FileUpload=function(){var d=null;var h=null;var f=null;function b(j){if(j&&j.error){alert(j.error)}}function i(j){if(j.lengthComputable){var k=Math.round(j.loaded*100/j.total);a("#snm-file-manager .snm-file-progress-text").html(k.toString()+"%");a("#snm-file-manager .snm-file-progress-percent").width(k.toString()+"%")}}function g(j){var k=jQuery.parseJSON(this.response);if(!k||k.status!=1){b(k);d=null}AuIt.FileUpload.uploadNextFile()}function c(j){d=null;AuIt.FileUpload.uploadNextFile();alert(AuIt.FileManagerOption.msg.m1)}function e(j){d=null;AuIt.FileUpload.uploadNextFile();alert(AuIt.FileManagerOption.msg.m2)}return{fileSelected:function(){if(d){return}a("#snm-file-manager").dialog("disable");var k=a("#snm-file-manager .snm-file-tree").jstree("get_selected").attr("id");a("#snm-file-manager .snm-file-tree").attr("disabled","disabled");var j=document.getElementById("fm_fileToUpload").files;d=j;f=k;h=0;AuIt.FileUpload.uploadNextFile()},uploadNextFile:function(){if(!d||h>=d.length){d=null;f=null;a("#snm-file-manager .snm-file-progress").hide();a("#snm-file-manager").dialog("enable");var k=jQuery.jstree._reference("#snm-file-manager .snm-file-tree");var n=k._get_node(null,false);var j=k._get_parent(n);k.refresh(j);return}var m=d[h++];if(m.size>=AuIt.FileManagerOption.MaxUploadSize){alert(AuIt.FileManagerOption.msg.m10);d=null;this.uploadNextFile();return}a("#snm-file-manager .snm-file-progress-text").html("");a("#snm-file-manager .snm-file-progress-percent").width("0%");a("#snm-file-manager .snm-file-progress").show();var l=new FormData();l.append("aimage",m);l.append("id",f);l.append("form_key",AuIt.FileManagerOption.formKey);l.append("operation","upload_default");var o=new XMLHttpRequest();o.upload.addEventListener("progress",i,false);o.addEventListener("load",g,false);o.addEventListener("error",c,false);o.addEventListener("abort",e,false);o.open("POST",AuIt.FileManagerOption.Url);o.send(l)}}}();AuIt.FileManager=function(){var c=null;var b=null;function e(g){if(g&&g.error){alert(g.error)}}function f(){var g=true;if(b){if(b.find(".ui-selected").attr("data-src")){g=false}}a("#fm-button-ok").button("option","disabled",g)}function d(h){var g={refresh:{separator_before:false,separator_after:true,label:AuIt.FileManagerOption.msg.c1,action:function(i){this.refresh(i)}},create:{separator_before:false,separator_after:false,label:AuIt.FileManagerOption.msg.c2,action:function(i){this.create(i,"last",{attr:{rel:"folder"}})}},rename:{separator_before:false,separator_after:false,label:AuIt.FileManagerOption.msg.c3,action:function(i){this.rename(i)}},remove:{separator_before:false,icon:false,separator_after:false,label:AuIt.FileManagerOption.msg.c4,action:function(i){if(this.is_selected(i)){this.remove()}else{this.remove(i)}}}};if(a(h).attr("rel")=="drive"){delete g.rename;delete g.remove}return g}return{show:function(h,g){AuIt.FileManagerOption.initialItem=null;if(!c){c=a("#snm-file-manager");a("#snm-file-manager:ui-dialog").dialog("destroy");c.dialog({minHeight:400,minWidth:600,modal:true,buttons:[{id:"fm-button-ok",text:"Ok",click:function(){a(this).dialog("close");if(g){g(b.find(".ui-selected").attr("data-src"))}}}]});this.initTree(h)}else{c.dialog("open");if(h){a("#snm-file-manager .snm-file-tree").jstree("search",h)}}f()},initTree:function(g){a("#snm-file-manager .snm-file-tree").jstree({plugins:["themes","json_data","ui","crrm","dnd","search","types","contextmenu"],themes:{theme:"classic",url:window.BLANK_URL.replace("blank.html","auit/publicationbasic/filetree/themes/classic/style.css")},contextmenu:{items:d},json_data:{ajax:{url:AuIt.FileManagerOption.Url,data:function(h){return{form_key:AuIt.FileManagerOption.formKey,operation:"get_children",id:h.attr?h.attr("id").replace("node_",""):1}}}},search:{ajax:{url:AuIt.FileManagerOption.Url,data:function(h){return{form_key:AuIt.FileManagerOption.formKey,operation:"search",search_str:h}}}},types:{max_depth:-2,max_children:-2,valid_children:["drive"],types:{"default":{valid_children:"none",},folder:{valid_children:["default","folder"],},drive:{valid_children:["default","folder"],start_drag:false,move_node:false,delete_node:false,remove:false}}},ui:{initially_select:g?[]:["ROOT"]},core:{initially_open:g?[]:["ROOT"]}}).bind("loaded.jstree",function(h,i){if(g){i.inst.search(g)}g=null}).bind("select_node.jstree",function(i,h){b=null;f();a.ajax({async:false,type:"GET",url:AuIt.FileManagerOption.Url,data:{form_key:AuIt.FileManagerOption.formKey,operation:"get_files",id:h.rslt.obj.attr("id"),}}).done(function(j){a("#snm-file-manager .snm-file-preview").html(j);b=a("#snm-file-manager .snm-file-preview ul");b.selectable({selected:function(l,m){f()}});if(AuIt.FileManagerOption.initialItem){var k=a(AuIt.FileManagerOption.initialItem);k.addClass("ui-selected").scrollParent().scrollTop(k.position().top)}AuIt.FileManagerOption.initialItem=null})}).bind("create.jstree",function(i,h){a.post(AuIt.FileManagerOption.Url,{form_key:AuIt.FileManagerOption.formKey,operation:"create_node",id:h.rslt.parent.attr("id").replace("node_",""),position:h.rslt.position,title:h.rslt.name,type:h.rslt.obj.attr("rel")},function(j){if(j.status){a(h.rslt.obj).attr("id","node_"+j.id)}else{a.jstree.rollback(h.rlbk)}})}).bind("remove.jstree",function(i,h){h.rslt.obj.each(function(){a.ajax({async:false,type:"POST",url:AuIt.FileManagerOption.Url,data:{form_key:AuIt.FileManagerOption.formKey,operation:"remove_node",id:this.id.replace("node_","")},success:function(j){if(!j.status){h.inst.refresh()}}})})}).bind("rename.jstree",function(i,h){a.post(AuIt.FileManagerOption.Url,{form_key:AuIt.FileManagerOption.formKey,operation:"rename_node",id:h.rslt.obj.attr("id").replace("node_",""),title:h.rslt.new_name},function(j){if(!j.status){a.jstree.rollback(h.rlbk);e(j)}else{h.args[0].attr("id",j.id)}})}).bind("upload.jstree",function(i,h){alert("upload")}).bind("move_node.jstree",function(i,h){h.rslt.o.each(function(j){a.ajax({async:false,type:"POST",url:AuIt.FileManagerOption.Url,data:{form_key:AuIt.FileManagerOption.formKey,operation:"move_node",id:a(this).attr("id").replace("node_",""),ref:h.rslt.cr===-1?1:h.rslt.np.attr("id").replace("node_",""),position:h.rslt.cp+j,title:h.rslt.name,copy:h.rslt.cy?1:0},success:function(k){if(!k.status){a.jstree.rollback(h.rlbk)}else{a(h.rslt.oc).attr("id","node_"+k.id);if(h.rslt.cy&&a(h.rslt.oc).children("UL").length){h.inst.refresh(h.inst._get_parent(h.rslt.oc))}}}})})});a("#fm_add_folder").button({text:true,icons:{primary:"ui-icon-seek-start"}}).click(function(){a("#snm-file-manager .snm-file-tree").jstree("create",null,"last",{attr:{rel:"folder"}})});a("#fm_rename").button({text:false,icons:{primary:"ui-icon-play"}}).click(function(){a("#snm-file-manager .snm-file-tree").jstree("rename",null,"last",{attr:{rel:"default"}})});a("#fm_remove").button({text:false,icons:{primary:"ui-icon-play"}}).click(function(){a("#snm-file-manager .snm-file-tree").jstree("remove",null,"last",{attr:{rel:"default"}})})}}}()}(jQuery));