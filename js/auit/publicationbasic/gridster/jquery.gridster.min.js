/* gridster.js - v0.1.0 - 2012-08-05
* http://gridster.net/
* Copyright (c) 2012 ducksboard; Licensed MIT */
(function(h,g,l,k){function j(a){return a[0]&&h.isPlainObject(a[0])?this.data=a[0]:this.el=a,this.isCoords=!0,this.coords={},this.init(),this}var i=j.prototype;i.init=function(){this.set(),this.original_coords=this.get()},i.set=function(m,f){var p=this.el;p&&!m&&(this.data=p.offset(),this.data.width=p.width(),this.data.height=p.height());if(p&&m&&!f){var o=p.offset();this.data.top=o.top,this.data.left=o.left}var n=this.data;return this.coords.x1=n.left,this.coords.y1=n.top,this.coords.x2=n.left+n.width,this.coords.y2=n.top+n.height,this.coords.cx=n.left+n.width/2,this.coords.cy=n.top+n.height/2,this.coords.width=n.width,this.coords.height=n.height,this.coords.el=p||!1,this},i.update=function(a){if(!a&&!this.el){return this}if(a){var d=h.extend({},this.data,a);return this.data=d,this.set(!0,!0)}return this.set(!0),this},i.get=function(){return this.coords},h.fn.coords=function(){if(this.data("coords")){return this.data("coords")}var b=new j(this,arguments[0]);return this.data("coords",b),b}})(jQuery,window,document),function(i,h,n,m){function k(a,f,e){this.options=i.extend(l,e),this.$element=a,this.last_colliders=[],this.last_colliders_coords=[],typeof f=="string"||f instanceof jQuery?this.$colliders=i(f,this.options.colliders_context).not(this.$element):this.colliders=i(f),this.init()}var l={colliders_context:n.body},j=k.prototype;j.init=function(){this.find_collisions()},j.overlaps=function(f,e){var o=!1,g=!1;if(e.x1>=f.x1&&e.x1<=f.x2||e.x2>=f.x1&&e.x2<=f.x2||f.x1>=e.x1&&f.x2<=e.x2){o=!0}if(e.y1>=f.y1&&e.y1<=f.y2||e.y2>=f.y1&&e.y2<=f.y2||f.y1>=e.y1&&f.y2<=e.y2){g=!0}return o&&g},j.detect_overlapping_region=function(f,e){var o="",g="";return f.y1>e.cy&&f.y1<e.y2&&(o="N"),f.y2>e.y1&&f.y2<e.cy&&(o="S"),f.x1>e.cx&&f.x1<e.x2&&(g="W"),f.x2>e.x1&&f.x2<e.cx&&(g="E"),o+g||"C"},j.calculate_overlapped_area_coords=function(a,s){var r=Math.max(a.x1,s.x1),q=Math.max(a.y1,s.y1),p=Math.min(a.x2,s.x2),o=Math.min(a.y2,s.y2);return i({left:r,top:q,width:p-r,height:o-q}).coords().get()},j.calculate_overlapped_area=function(b){return b.width*b.height},j.manage_colliders_start_stop=function(a,u,t){var s=this.last_colliders_coords;for(var r=0,q=s.length;r<q;r++){i.inArray(s[r],a)===-1&&u.call(this,s[r])}for(var p=0,o=a.length;p<o;p++){i.inArray(a[p],s)===-1&&t.call(this,a[p])}},j.find_collisions=function(D){var C=this,B=[],A=[],z=this.colliders||this.$colliders,y=z.length,x=C.$element.coords().update(D||!1).get();while(y--){var w=C.$colliders?i(z[y]):z[y],v=w.isCoords?w:w.coords(),u=v.get(),t=C.overlaps(x,u);if(!t){continue}var s=C.detect_overlapping_region(x,u);if(s==="C"){var r=C.calculate_overlapped_area_coords(x,u),q=C.calculate_overlapped_area(r),a={area:q,area_coords:r,region:s,coords:u,player_coords:x,el:w};C.options.on_overlap&&C.options.on_overlap.call(this,a),B.push(v),A.push(a)}}return(C.options.on_overlap_stop||C.options.on_overlap_start)&&this.manage_colliders_start_stop(B,C.options.on_overlap_stop,C.options.on_overlap_start),this.last_colliders_coords=B,A},j.get_closest_colliders=function(e){var d=this.find_collisions(e),f=100;return d.sort(function(g,c){return g.area<=f?1:g.region==="C"&&c.region==="C"?g.coords.y1<c.coords.y1||g.coords.x1<c.coords.x1?-1:1:g.area<c.area?1:1}),d},i.fn.collision=function(d,c){return new k(this,d,c)}}(jQuery,window,document),function(d,c){d.debounce=function(f,e,h){var g;return function(){var i=this,b=arguments,a=function(){g=null,h||f.apply(i,b)};h&&!g&&f.apply(i,b),clearTimeout(g),g=setTimeout(a,e)}},d.throttle=function(r,q){var p,o,n,m,l,k,j=debounce(function(){l=m=!1},q);return function(){p=this,o=arguments;var a=function(){n=null,l&&r.apply(p,o),j()};return n||(n=setTimeout(a,q)),m?l=!0:k=r.apply(p,o),j(),m=!0,k}}}(window),function(t,s,r,q){function l(a,c){this.options=t.extend({},p,c),this.$body=t(r.body),this.$container=t(a),this.$dragitems=t(this.options.items,this.$container),this.is_dragging=!1,this.player_min_left=0+this.options.offset_left,this.init()}var p={items:".gs_w",distance:1,limit:!0,offset_left:0,autoscroll:!0},o=t(s),n="ontouchstart" in s,m={start:n?"touchstart":"mousedown.draggable",move:n?"touchmove":"mousemove.draggable",end:n?"touchend":"mouseup.draggable"},k=l.prototype;k.init=function(){this.calculate_positions(),this.$container.css("position","relative"),this.enable(),t(s).bind("resize",throttle(t.proxy(this.calculate_positions,this),200))},k.get_actual_pos=function(d){var c=d.position();return c},k.get_mouse_pos=function(d){if(n){var c=d.originalEvent;d=c.touches.length?c.touches[0]:c.changedTouches[0]}return{left:d.clientX,top:d.clientY}},k.get_offset=function(h){h.preventDefault();var g=this.get_mouse_pos(h),v=Math.round(g.left-this.mouse_init_pos.left),u=Math.round(g.top-this.mouse_init_pos.top),j=Math.round(this.el_init_offset.left+v-this.baseX),i=Math.round(this.el_init_offset.top+u-this.baseY+this.scrollOffset);return this.options.limit&&(j>this.player_max_left?j=this.player_max_left:j<this.player_min_left&&(j=this.player_min_left)),{left:j,top:i,mouse_left:g.left,mouse_top:g.top}},k.manage_scroll=function(C){var B,A=o.scrollTop(),z=A,y=z+this.window_height,x=y-50,w=z+50,v=C.mouse_left,u=z+C.mouse_top,f=this.doc_height-this.window_height+this.player_height;u>=x&&(B=A+30,B<f&&(o.scrollTop(B),this.scrollOffset=this.scrollOffset+30)),u<=w&&(B=A-30,B>0&&(o.scrollTop(B),this.scrollOffset=this.scrollOffset-30))},k.calculate_positions=function(b){this.window_height=o.height()},k.drag_handler=function(a){var h=a.target.nodeName;if(a.which!==1&&!n){return}if(h==="INPUT"||h==="TEXTAREA"||h==="SELECT"){return}var g=this,f=!0;this.$player=t(a.currentTarget),this.el_init_pos=this.get_actual_pos(this.$player),this.mouse_init_pos=this.get_mouse_pos(a),this.offsetY=this.mouse_init_pos.top-this.el_init_pos.top,this.$body.on(m.move,function(e){var d=g.get_mouse_pos(e),j=Math.abs(d.left-g.mouse_init_pos.left),i=Math.abs(d.top-g.mouse_init_pos.top);return j>g.options.distance||i>g.options.distance?f?(f=!1,g.on_dragstart.call(g,e),!1):(g.is_dragging==!0&&g.on_dragmove.call(g,e),!1):!1})},k.on_dragstart=function(a){a.preventDefault(),this.drag_start=!0,this.is_dragging=!0;var c=this.$container.offset();return this.baseX=Math.round(c.left),this.baseY=Math.round(c.top),this.doc_height=t(r).height(),this.options.helper==="clone"?(this.$helper=this.$player.clone().appendTo(this.$container).addClass("helper"),this.helper=!0):this.helper=!1,this.scrollOffset=0,this.el_init_offset=this.$player.offset(),this.player_width=this.$player.width(),this.player_height=this.$player.height(),this.player_max_left=this.$container.width()-this.player_width+this.options.offset_left,this.options.start&&this.options.start.call(this.$player,a,{helper:this.helper?this.$helper:this.$player}),!1},k.on_dragmove=function(e){var d=this.get_offset(e);this.options.autoscroll&&this.manage_scroll(d),(this.helper?this.$helper:this.$player).css({position:"absolute",left:d.left,top:d.top});var f={position:{left:d.left,top:d.top}};return this.options.drag&&this.options.drag.call(this.$player,e,f),!1},k.on_dragstop=function(e){var d=this.get_offset(e);this.drag_start=!1;var f={position:{left:d.left,top:d.top}};return this.options.stop&&this.options.stop.call(this.$player,e,f),this.helper&&this.$helper.remove(),!1},k.enable=function(){this.$container.on(m.start,this.options.items,t.proxy(this.drag_handler,this)),this.$body.on(m.end,t.proxy(function(b){this.is_dragging=!1,this.$body.off(m.move),this.drag_start&&this.on_dragstop(b)},this))},k.disable=function(){this.$container.off(m.start),this.$body.off(m.end)},k.destroy=function(){this.disable(),t.removeData(this.$container,"draggable")},t.fn.draggable=function(a){return this.each(function(){t.data(this,"draggable")||t.data(this,"draggable",new l(this,a))})}}(jQuery,window,document),function(i,h,n,m){function k(a,d){this.options=i.extend(!0,l,d),this.$el=i(a),this.$wrapper=this.$el.parent(),this.$widgets=i(this.options.widget_selector,this.$el).addClass("gs_w"),this.widgets=[],this.$changed=i([]),this.wrapper_width=this.$wrapper.width(),this.min_widget_width=this.options.widget_margins[0]*2+this.options.widget_base_dimensions[0],this.min_widget_height=this.options.widget_margins[1]*2+this.options.widget_base_dimensions[1],this.init()}var l={widget_selector:"> li",widget_margins:[10,10],widget_base_dimensions:[400,225],extra_rows:0,extra_cols:0,min_cols:1,min_rows:15,autogenerate_stylesheet:!0,avoid_overlapped_widgets:!0,serialize_params:function(d,c){return{col:c.col,row:c.row}},collision:{},draggable:{distance:4}};k.generated_stylesheets=[];var j=k.prototype;j.init=function(){this.generate_grid_and_stylesheet(),this.get_widgets_from_DOM(),this.set_dom_grid_height(),this.$wrapper.addClass("ready"),this.draggable(),i(h).bind("resize",throttle(i.proxy(this.recalculate_faux_grid,this),200))},j.disable=function(){return this.$wrapper.find(".player-revert").removeClass("player-revert"),this.drag_api.disable(),this},j.enable=function(){return this.drag_api.enable(),this},j.add_widget=function(a,q,p){var o=this.next_position(q,p),g=i(a).attr({"data-col":o.col,"data-row":o.row,"data-sizex":o.size_x,"data-sizey":o.size_y}).addClass("gs_w").appendTo(this.$el).hide();return this.$widgets=this.$widgets.add(g),this.register_widget(g),this.set_dom_grid_height(),g.fadeIn()},j.next_position=function(w,v){w||(w=1),v||(v=1);var u=this.gridmap,t=u.length,s=[];for(var r=1;r<t;r++){var q=u[r].length;for(var p=1;p<=q;p++){var o=this.can_move_to({size_x:w,size_y:v},r,p);o&&s.push({col:r,row:p,size_y:v,size_x:w})}}return s.length?this.sort_by_row_and_col_asc(s)[0]:!1},j.remove_widget=function(a,q){var p=a instanceof jQuery?a:i(a),o=p.coords().grid;this.cells_occupied_by_placeholder={},this.$widgets=this.$widgets.not(p);var g=this.widgets_below(p);this.remove_from_gridmap(o),p.fadeOut(i.proxy(function(){p.remove(),g.each(i.proxy(function(d,e){this.move_widget_up(i(e),o.size_y)},this)),this.set_dom_grid_height(),q&&q.call(this,a)},this))},j.serialize=function(a){a||(a=this.$widgets);var d=[];return a.each(i.proxy(function(c,e){d.push(this.options.serialize_params(i(e),i(e).coords().grid))},this)),d},j.serialize_changed=function(){return this.serialize(this.$changed)},j.register_widget=function(d){var c={col:parseInt(d.attr("data-col"),10),row:parseInt(d.attr("data-row"),10),size_x:parseInt(d.attr("data-sizex"),10),size_y:parseInt(d.attr("data-sizey"),10),el:d};return this.options.avoid_overlapped_widgets&&!this.can_move_to({size_x:c.size_x,size_y:c.size_y},c.col,c.row)&&(c=this.next_position(c.size_x,c.size_y),c.el=d,d.attr({"data-col":c.col,"data-row":c.row,"data-sizex":c.size_x,"data-sizey":c.size_y})),d.data("coords",d.coords()),d.data("coords").grid=c,this.add_to_gridmap(c,d),this.widgets.push(d),this},j.update_widget_position=function(d,c){return this.for_each_cell_occupied(d,function(b,e){if(!this.gridmap[b]){return this}this.gridmap[b][e]=c}),this},j.remove_from_gridmap=function(b){return this.update_widget_position(b,!1)},j.add_to_gridmap=function(a,f){this.update_widget_position(a,f||a.el);if(a.el){var e=this.widgets_below(a.el);e.each(i.proxy(function(d,g){this.move_widget_up(i(g))},this))}},j.draggable=function(){var a=this,d=i.extend(!0,{},this.options.draggable,{offset_left:this.options.widget_margins[0],items:".gs_w",start:function(e,b){a.$widgets.filter(".player-revert").removeClass("player-revert"),a.$player=i(this),a.$helper=a.options.draggable.helper==="clone"?i(b.helper):a.$player,a.helper=!a.$helper.is(a.$player),a.on_start_drag.call(a,e,b),a.$el.trigger("gridster:dragstart")},stop:function(b,e){a.on_stop_drag.call(a,b,e),a.$el.trigger("gridster:dragstop")},drag:throttle(function(b,e){a.on_drag.call(a,b,e),a.$el.trigger("gridster:drag")},60)});return this.drag_api=this.$el.draggable(d).data("draggable"),this},j.on_start_drag=function(a,o){this.$helper.add(this.$player).add(this.$wrapper).addClass("dragging"),this.$player.addClass("player"),this.player_grid_data=this.$player.coords().grid,this.placeholder_grid_data=i.extend({},this.player_grid_data),this.$el.css("height",this.$el.height()+this.player_grid_data.size_y*this.min_widget_height);var g=this.faux_grid,f=this.$player.data("coords").coords;this.cells_occupied_by_player=this.get_cells_occupied(this.player_grid_data),this.cells_occupied_by_placeholder=this.get_cells_occupied(this.placeholder_grid_data),this.last_cols=[],this.last_rows=[],this.collision_api=this.$helper.collision(g,this.options.collision),this.$preview_holder=i("<li />",{"class":"preview-holder","data-row":this.$player.attr("data-row"),"data-col":this.$player.attr("data-col"),css:{width:f.width,height:f.height}}).appendTo(this.$el),this.options.draggable.start&&this.options.draggable.start.call(this,a,o)},j.on_drag=function(e,d){var f={left:d.position.left+this.baseX,top:d.position.top+this.baseY};this.colliders_data=this.collision_api.get_closest_colliders(f),this.on_overlapped_column_change(this.on_start_overlapping_column,this.on_stop_overlapping_column),this.on_overlapped_row_change(this.on_start_overlapping_row,this.on_stop_overlapping_row),this.helper&&this.$player&&this.$player.css({left:d.position.left,top:d.position.top}),this.options.draggable.drag&&this.options.draggable.drag.call(this,e,d)},j.on_stop_drag=function(d,c){this.$helper.add(this.$player).add(this.$wrapper).removeClass("dragging"),c.position.left=c.position.left+this.baseX,c.position.top=c.position.top+this.baseY,this.colliders_data=this.collision_api.get_closest_colliders(c.position),this.on_overlapped_column_change(this.on_start_overlapping_column,this.on_stop_overlapping_column),this.on_overlapped_row_change(this.on_start_overlapping_row,this.on_stop_overlapping_row),this.$player.addClass("player-revert").removeClass("player").attr({"data-col":this.placeholder_grid_data.col,"data-row":this.placeholder_grid_data.row}).css({left:"",top:""}),this.$changed=this.$changed.add(this.$player),this.cells_occupied_by_player=this.get_cells_occupied(this.placeholder_grid_data),this.set_cells_player_occupies(this.placeholder_grid_data.col,this.placeholder_grid_data.row),this.$player.coords().grid.row=this.placeholder_grid_data.row,this.$player.coords().grid.col=this.placeholder_grid_data.col,this.$player=null,this.$preview_holder.remove(),this.set_dom_grid_height(),this.options.draggable.stop&&this.options.draggable.stop.call(this,d,c)},j.on_overlapped_column_change=function(a,s){if(!this.colliders_data.length){return}var r=this.get_targeted_columns(this.colliders_data[0].el.data.col),q=this.last_cols.length,p=r.length,o;for(o=0;o<p;o++){i.inArray(r[o],this.last_cols)===-1&&(a||i.noop).call(this,r[o])}for(o=0;o<q;o++){i.inArray(this.last_cols[o],r)===-1&&(s||i.noop).call(this,this.last_cols[o])}return this.last_cols=r,this},j.on_overlapped_row_change=function(a,s){if(!this.colliders_data.length){return}var r=this.get_targeted_rows(this.colliders_data[0].el.data.row),q=this.last_rows.length,p=r.length,o;for(o=0;o<p;o++){i.inArray(r[o],this.last_rows)===-1&&(a||i.noop).call(this,r[o])}for(o=0;o<q;o++){i.inArray(this.last_rows[o],r)===-1&&(s||i.noop).call(this,this.last_rows[o])}this.last_rows=r},j.set_player=function(w,v){this.empty_cells_player_occupies();var u=this,t=u.colliders_data[0].el.data,s=t.col,r=v||t.row;this.player_grid_data={col:s,row:r,size_y:this.player_grid_data.size_y,size_x:this.player_grid_data.size_x},this.cells_occupied_by_player=this.get_cells_occupied(this.player_grid_data);var q=this.get_widgets_overlapped(this.player_grid_data),p=this.widgets_constraints(q);this.manage_movements(p.can_go_up,s,r),this.manage_movements(p.can_not_go_up,s,r);if(!q.length){var o=this.can_go_player_up(this.player_grid_data);o!==!1&&(r=o),this.set_placeholder(s,r)}return{col:s,row:r}},j.widgets_constraints=function(a){var q=i([]),p,o=[],g=[];return a.each(i.proxy(function(c,r){var f=i(r),e=f.coords().grid;this.can_go_widget_up(e)?(q=q.add(f),o.push(e)):g.push(e)},this)),p=a.not(q),{can_go_up:this.sort_by_row_asc(o),can_not_go_up:this.sort_by_row_desc(g)}},j.sort_by_row_asc=function(b){return b=b.sort(function(d,c){return d.row>c.row?1:-1}),b},j.sort_by_row_and_col_asc=function(b){return b=b.sort(function(d,c){return d.row>c.row||d.row==c.row&&d.col>c.col?1:-1}),b},j.sort_by_col_asc=function(b){return b=b.sort(function(d,c){return d.col>c.col?1:-1}),b},j.sort_by_row_desc=function(b){return b=b.sort(function(d,c){return d.row+d.size_y<c.row+c.size_y?1:-1}),b},j.manage_movements=function(a,f,e){return i.each(a,i.proxy(function(d,c){var s=c,r=s.el,q=this.can_go_widget_up(s);if(q){this.move_widget_to(r,q),this.set_placeholder(f,q+s.size_y)}else{var p=this.can_go_player_up(this.player_grid_data);if(!p){var o=e+this.player_grid_data.size_y-s.row;this.move_widget_down(r,o),this.set_placeholder(f,e)}}},this)),this},j.is_player=function(e,d){if(d&&!this.gridmap[e]){return !1}var f=d?this.gridmap[e][d]:e;return f&&(f.is(this.$player)||f.is(this.$helper))},j.is_player_in=function(a,f){var e=this.cells_occupied_by_player;return i.inArray(a,e.cols)>=0&&i.inArray(f,e.rows)>=0},j.is_placeholder_in=function(a,f){var e=this.cells_occupied_by_placeholder||{};return this.is_placeholder_in_col(a)&&i.inArray(f,e.rows)>=0},j.is_placeholder_in_col=function(a){var d=this.cells_occupied_by_placeholder||[];return i.inArray(a,d.cols)>=0},j.is_empty=function(d,c){return typeof this.gridmap[d]!="undefined"&&typeof this.gridmap[d][c]!="undefined"&&this.gridmap[d][c]===!1?!0:!1},j.is_occupied=function(d,c){return this.gridmap[d]?this.gridmap[d][c]?!0:!1:!1},j.is_widget=function(e,d){var f=this.gridmap[e];return f?(f=f[d],f?f:!1):!1},j.is_widget_under_player=function(d,c){return this.is_widget(d,c)?this.is_player_in(d,c):!1},j.get_widgets_under_player=function(){var a=this.cells_occupied_by_player,d=i([]);return i.each(a.cols,i.proxy(function(c,b){i.each(a.rows,i.proxy(function(f,e){this.is_widget(b,e)&&(d=d.add(this.gridmap[b][e]))},this))},this)),d},j.set_placeholder=function(a,t){var s=i.extend({},this.placeholder_grid_data),r=this.widgets_below({col:s.col,row:s.row,size_y:s.size_y,size_x:s.size_x}),q=a+s.size_x-1;q>this.cols&&(a=a-(q-a));var p=this.placeholder_grid_data.row<t,o=this.placeholder_grid_data.col!==a;this.placeholder_grid_data.col=a,this.placeholder_grid_data.row=t,this.cells_occupied_by_placeholder=this.get_cells_occupied(this.placeholder_grid_data),this.$preview_holder.attr({"data-row":t,"data-col":a}),(p||o)&&r.each(i.proxy(function(d,b){this.move_widget_up(i(b),this.placeholder_grid_data.col-a+s.size_y)},this))},j.can_go_player_up=function(o){var g=o.row+o.size_y-1,s=!0,r=[],q=10000,p=this.get_widgets_under_player();return this.for_each_column_occupied(o,function(b){var d=this.gridmap[b],c=g+1;r[b]=[];while(--c>0){if(this.is_empty(b,c)||this.is_player(b,c)||this.is_widget(b,c)&&d[c].is(p)){r[b].push(c),q=c<q?c:q}else{break}}if(r[b].length===0){return s=!1,!0}r[b].sort()}),s?this.get_valid_rows(o,r,q):!1},j.can_go_widget_up=function(g){var f=g.row+g.size_y-1,q=!0,p=[],o=10000;return this.for_each_column_occupied(g,function(b){var d=this.gridmap[b];p[b]=[];var c=f+1;while(--c>0){if(this.is_occupied(b,c)&&!this.is_player(b,c)){break}!this.is_player(b,c)&&!this.is_placeholder_in(b,c)&&p[b].push(c),c<o&&(o=c)}if(p[b].length===0){return q=!1,!0}p[b].sort()}),q?this.get_valid_rows(g,p,o):!1},j.get_valid_rows=function(w,v,u){var t=w.row,s=w.row+w.size_y-1,r=w.size_y,q=u-1,p=[];while(++q<=s){var o=!0;i.each(v,function(d,e){e&&i.inArray(q,e)===-1&&(o=!1)});if(o===!0){p.push(q);if(p.length===r){break}}}var a=!1;return r===1?p[0]!==t&&(a=p[0]||!1):p[0]!==t&&(a=this.get_consecutive_numbers_index(p,r)),a},j.get_consecutive_numbers_index=function(p,o){var u=p.length,t=[],s=!0,r=-1;for(var q=0;q<u;q++){if(s||p[q]===r+1){t.push(q);if(t.length===o){break}s=!1}else{t=[],s=!0}r=p[q]}return t.length>=o?p[t[0]]:!1},j.get_widgets_overlapped=function(){var a,o=i([]),g=[],f=this.cells_occupied_by_player.rows.slice(0);return f.reverse(),i.each(this.cells_occupied_by_player.cols,i.proxy(function(c,d){i.each(f,i.proxy(function(p,r){if(!this.gridmap[d]){return !0}var q=this.gridmap[d][r];this.is_occupied(d,r)&&!this.is_player(q)&&i.inArray(q,g)===-1&&(o=o.add(q),g.push(q))},this))},this)),o},j.on_start_overlapping_column=function(b){this.set_player(b,!1)},j.on_start_overlapping_row=function(b){this.set_player(!1,b)},j.on_stop_overlapping_column=function(d){this.set_player();var c=this;this.for_each_widget_below(d,this.cells_occupied_by_player.rows[0],function(b,e){c.move_widget_up(this,c.player_grid_data.size_y)})},j.on_stop_overlapping_row=function(g){this.set_player();var f=this,q=this.cells_occupied_by_player.cols;for(var p=0,o=q.length;p<o;p++){this.for_each_widget_below(q[p],g,function(b,d){f.move_widget_up(this,f.player_grid_data.size_y)})}},j.move_widget_to=function(a,t){var s=this,r=a.coords().grid,q=t-r.row,p=this.widgets_below(a),o=this.can_move_to(r,r.col,t,a);return o===!1?!1:(this.remove_from_gridmap(r),r.row=t,this.add_to_gridmap(r),a.attr("data-row",t),this.$changed=this.$changed.add(a),p.each(function(d,x){var w=i(x),v=w.coords().grid,u=s.can_go_widget_up(v);u&&u!==v.row&&s.move_widget_to(w,u)}),this)},j.move_widget_up=function(a,s){var r=a.coords().grid,q=r.row,p=[],o=!0;s||(s=1);if(!this.can_go_up(a)){return !1}this.for_each_column_occupied(r,function(f){if(i.inArray(a,p)===-1){var e=a.coords().grid,c=q-s;c=this.can_go_up_to_row(e,f,c);if(!c){return !0}var b=this.widgets_below(a);this.remove_from_gridmap(e),e.row=c,this.add_to_gridmap(e),a.attr("data-row",e.row),this.$changed=this.$changed.add(a),p.push(a),b.each(i.proxy(function(g,t){this.move_widget_up(i(t),s)},this))}})},j.move_widget_down=function(v,u){var t=v.coords().grid,s=t.row,r=[],q=u;if(!v){return !1}if(i.inArray(v,r)===-1){var p=v.coords().grid,o=s+u,a=this.widgets_below(v);this.remove_from_gridmap(p),a.each(i.proxy(function(g,z){var y=i(z),x=y.coords().grid,w=this.displacement_diff(x,p,q);w>0&&this.move_widget_down(y,w)},this)),p.row=o,this.update_widget_position(p,v),v.attr("data-row",p.row),this.$changed=this.$changed.add(v),r.push(v)}},j.can_go_up_to_row=function(x,w,v){var u=this.gridmap,t=!0,s=[],r=x.row,q;this.for_each_column_occupied(x,function(d){var c=u[d];s[d]=[],q=r;while(q--){if(this.is_empty(d,q)&&!this.is_placeholder_in(d,q)){s[d].push(q)}else{break}}if(!s[d].length){return t=!1,!0}});if(!t){return !1}q=v;for(q=1;q<r;q++){var p=!0;for(var o=0,a=s.length;o<a;o++){s[o]&&i.inArray(q,s[o])===-1&&(p=!1)}if(p===!0){t=q;break}}return t},j.displacement_diff=function(p,o,u){var t=p.row,s=[],r=o.row+o.size_y;this.for_each_column_occupied(p,function(e){var d=0;for(var f=r;f<t;f++){this.is_empty(e,f)&&(d=d+1)}s.push(d)});var q=Math.max.apply(Math,s);return u=u-q,u>0?u:0},j.widgets_below=function(a){var s=i.isPlainObject(a)?a:a.coords().grid,r=this,q=this.gridmap,p=s.row+s.size_y-1,o=i([]);return this.for_each_column_occupied(s,function(c){r.for_each_widget_below(c,p,function(d,e){if(!r.is_player(this)&&i.inArray(this,o)===-1){return o=o.add(this),!0}})}),this.sort_by_row_asc(o)},j.set_cells_player_occupies=function(d,c){return this.remove_from_gridmap(this.placeholder_grid_data),this.placeholder_grid_data.col=d,this.placeholder_grid_data.row=c,this.add_to_gridmap(this.placeholder_grid_data,this.$player),this},j.empty_cells_player_occupies=function(){return this.remove_from_gridmap(this.placeholder_grid_data),this},j.can_go_up=function(p){var o=p.coords().grid,u=o.row,t=u-1,s=this.gridmap,r=[],q=!0;return u===1?!1:(this.for_each_column_occupied(o,function(d){var c=this.is_widget(d,t);if(this.is_occupied(d,t)||this.is_player(d,t)||this.is_placeholder_in(d,t)){return q=!1,!0}}),q)},j.can_move_to=function(p,o,v){var u=this.gridmap,t=p.el,s={size_y:p.size_y,size_x:p.size_x,col:o,row:v},r=!0,q=o+p.size_x-1;return q>this.cols?!1:(this.for_each_cell_occupied(s,function(a,f){var e=this.is_widget(a,f);e&&(!p.el||e.is(t))&&(r=!1)}),r)},j.get_targeted_columns=function(f){var e=(f||this.player_grid_data.col)+(this.player_grid_data.size_x-1),o=[];for(var g=f;g<=e;g++){o.push(g)}return o},j.get_targeted_rows=function(f){var e=(f||this.player_grid_data.row)+(this.player_grid_data.size_y-1),o=[];for(var g=f;g<=e;g++){o.push(g)}return o},j.get_cells_occupied=function(g){var f={cols:[],rows:[]},q;arguments[1] instanceof jQuery&&(g=arguments[1].coords().grid);for(q=0;q<g.size_x;q++){var p=g.col+q;f.cols.push(p)}for(q=0;q<g.size_y;q++){var o=g.row+q;f.rows.push(o)}return f},j.for_each_cell_occupied=function(d,c){return this.for_each_column_occupied(d,function(a){this.for_each_row_occupied(d,function(b){c.call(this,a,b)})}),this},j.for_each_column_occupied=function(f,e){for(var o=0;o<f.size_x;o++){var g=f.col+o;e.call(this,g,f)}},j.for_each_row_occupied=function(f,e){for(var o=0;o<f.size_y;o++){var g=f.row+o;e.call(this,g,f)}},j._traversing_widgets=function(z,y,x,w,v){var u=this.gridmap;if(!u[x]){return}var t,s,r=z+"/"+y;if(arguments[2] instanceof jQuery){var q=arguments[2].coords().grid;x=q.col,w=q.row,v=arguments[3]}var p=[],o=w,a={"for_each/above":function(){while(o--){if(o>0&&this.is_widget(x,o)&&i.inArray(u[x][o],p)===-1){t=v.call(u[x][o],x,o),p.push(u[x][o]);if(t){break}}}},"for_each/below":function(){for(o=w+1,s=u[x].length;o<s;o++){if(this.is_widget(x,o)&&i.inArray(u[x][o],p)===-1){t=v.call(u[x][o],x,o),p.push(u[x][o]);if(t){break}}}}};a[r]&&a[r].call(this)},j.for_each_widget_above=function(e,d,f){return this._traversing_widgets("for_each","above",e,d,f),this},j.for_each_widget_below=function(e,d,f){return this._traversing_widgets("for_each","below",e,d,f),this},j.get_highest_occupied_cell=function(){var o,g=this.gridmap,s=[],r=[];for(var q=g.length-1;q>=1;q--){for(o=g[q].length-1;o>=1;o--){if(this.is_widget(q,o)){s.push(o),r[o]=q;break}}}var p=Math.max.apply(Math,s);return this.highest_occupied_cell={col:r[p],row:p},this.highest_occupied_cell},j.get_widgets_from=function(a,o){var g=this.gridmap,f=i();return a&&(f=f.add(this.$widgets.filter(function(){var b=i(this).attr("data-col");return b===a||b>a}))),o&&(f=f.add(this.$widgets.filter(function(){var c=i(this).attr("data-row");return c===o||c>o}))),f},j.set_dom_grid_height=function(){var b=this.get_highest_occupied_cell().row;return this.$el.css("height",b*this.min_widget_height),this},j.generate_stylesheet=function(v){var u="",t=10,s=6,r=6,q,p;v||(v={}),v.cols||(v.cols=this.cols),v.rows||(v.rows=this.rows),v.namespace||(v.namespace=""),v.widget_base_dimensions||(v.widget_base_dimensions=this.options.widget_base_dimensions),v.widget_margins||(v.widget_margins=this.options.widget_margins),v.min_widget_width=v.widget_margins[0]*2+v.widget_base_dimensions[0],v.min_widget_height=v.widget_margins[1]*2+v.widget_base_dimensions[1];var o=i.param(v);if(i.inArray(o,k.generated_stylesheets)>=0){return !1}k.generated_stylesheets.push(o);for(q=v.cols+t;q>=0;q--){u+=v.namespace+' [data-col="'+(q+1)+'"] { left:'+(q*v.widget_base_dimensions[0]+q*v.widget_margins[0]+(q+1)*v.widget_margins[0])+"px;} "}for(q=v.rows+t;q>=0;q--){u+=v.namespace+' [data-row="'+(q+1)+'"] { top:'+(q*v.widget_base_dimensions[1]+q*v.widget_margins[1]+(q+1)*v.widget_margins[1])+"px;} "}for(var f=1;f<s;f++){u+=v.namespace+' [data-sizey="'+f+'"] { height:'+(f*v.widget_base_dimensions[1]+(f-1)*v.widget_margins[1]*2)+"px;}"}for(var a=1;a<r;a++){u+=v.namespace+' [data-sizex="'+a+'"] { width:'+(a*v.widget_base_dimensions[0]+(a-1)*v.widget_margins[0]*2)+"px;}"}return this.add_style_tag(u)},j.add_style_tag=function(e){var c=n,f=c.createElement("style");return c.getElementsByTagName("head")[0].appendChild(f),f.setAttribute("type","text/css"),f.styleSheet?f.styleSheet.cssText=e:f.appendChild(n.createTextNode(e)),this},j.generate_faux_grid=function(a,q){this.faux_grid=[],this.gridmap=[];var p,o;for(p=q;p>0;p--){this.gridmap[p]=[];for(o=a;o>0;o--){var g=i({left:this.baseX+(p-1)*this.min_widget_width,top:this.baseY+(o-1)*this.min_widget_height,width:this.min_widget_width,height:this.min_widget_height,col:p,row:o,original_col:p,original_row:o}).coords();this.gridmap[p][o]=!1,this.faux_grid.push(g)}}return this},j.recalculate_faux_grid=function(){var a=this.$wrapper.width();return this.baseX=(i(h).width()-a)/2,this.baseY=this.$wrapper.offset().top,i.each(this.faux_grid,i.proxy(function(d,c){this.faux_grid[d]=c.update({left:this.baseX+(c.data.col-1)*this.min_widget_width,top:this.baseY+(c.data.row-1)*this.min_widget_height})},this)),this},j.get_widgets_from_DOM=function(){return this.$widgets.each(i.proxy(function(a,d){this.register_widget(i(d))},this)),this},j.generate_grid_and_stylesheet=function(){var t=this.$wrapper.width(),s=this.$wrapper.height(),r=Math.floor(t/this.min_widget_width)+this.options.extra_cols,q=Math.floor(s/this.min_widget_height)+this.options.extra_rows,p=this.$widgets.map(function(){return i(this).attr("data-col")});p=Array.prototype.slice.call(p,0),p.length||(p=[0]);var o=this.$widgets.map(function(){return i(this).attr("data-row")});o=Array.prototype.slice.call(o,0),o.length||(o=[0]);var b=Math.max.apply(Math,p),a=Math.max.apply(Math,o);return this.cols=Math.max(b,r,this.options.min_cols),this.rows=Math.max(a,q,this.options.min_rows),this.baseX=(i(h).width()-t)/2,this.baseY=this.$wrapper.offset().top,this.options.autogenerate_stylesheet&&this.generate_stylesheet(),this.generate_faux_grid(this.rows,this.cols)},i.fn.gridster=function(a){return this.each(function(){i(this).data("gridster")||i(this).data("gridster",new k(this,a))})}}(jQuery,window,document);